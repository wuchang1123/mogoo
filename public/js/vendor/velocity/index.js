(function(win){var Velocity=function(asts){this.asts=asts;this.init()};Velocity.Helper={};Velocity.prototype={constructor:Velocity};var guid=0;var utils={forEach:function(data,cb,host){data&&data.length&&_.each(data,function(d,index){cb.apply(host,arguments)})},some:_.some,mixin:jQuery.extend,guid:function(){guid++;return"velocity-1111-2222"+guid},isArray:jQuery.isArray,indexOf:jQuery.inArray,keys:_.keys,now:jQuery.now};!function(Helper,utils){function getRefText(ast){var ret=ast.leader;var isFn=ast.args!==undefined;if(ast.isWraped)ret+="{";if(isFn){ret+=getMethodText(ast)}else{ret+=ast.id}utils.forEach(ast.path,function(ref){if(ref.type=="method"){ret+="."+getMethodText(ref)}else if(ref.type=="index"){var text="";var id=ref.id;if(id.type==="integer"){text=id.value}else if(id.type==="string"){var sign=id.isEval?'"':"'";text=sign+id.value+sign}else{text=getRefText(id)}ret+="["+text+"]"}else if(ref.type=="property"){ret+="."+ref.id}},this);if(ast.isWraped)ret+="}";return ret}function getMethodText(ref){var args=[];var ret="";utils.forEach(ref.args,function(arg){args.push(getLiteral(arg))});ret+=ref.id+"("+args.join(",")+")";return ret}function getLiteral(ast){var ret="";switch(ast.type){case"string":{var sign=ast.isEval?'"':"'";ret=sign+ast.value+sign;break}case"integer":case"bool":{ret=ast.value;break}case"array":{ret="[";var len=ast.value.length-1;utils.forEach(ast.value,function(arg,i){ret+=getLiteral(arg);if(i!==len)ret+=", "});ret+="]";break}default:ret=getRefText(ast)}return ret}Helper.getRefText=getRefText}(Velocity.Helper,utils);!function(Velocity,utils){utils.mixin(Velocity.prototype,{getBlock:function(block){var ast=block[0];var ret="";var _block=[ast];var _inBlock=[];var index=0;var blockTypes=["if","foreach","macro","noescape","define"];utils.forEach(block,function(ast,i){if(i){if(utils.indexOf(ast.type,blockTypes)!==-1){index++;_inBlock.push(ast)}else if(ast.type==="end"){index--;if(index){_inBlock.push(ast)}else{_block.push(_inBlock.slice());_inBlock=[]}}else{index?_inBlock.push(ast):_block.push(ast)}}});if(ast.type==="if"){ret=this.getBlockIf(_block)}else if(ast.type==="foreach"){ret=this.getBlockEach(_block)}else if(ast.type==="macro"){this.setBlockMacro(_block)}else if(ast.type==="noescape"){ret=this._render(_block.slice(1))}return ret},setBlockMacro:function(block){var ast=block[0];var _block=block.slice(1);var macros=this.macros;macros[ast.id]={asts:_block,args:ast.args}},getMacro:function(ast){var macro=this.macros[ast.id];var ret="";if(!macro){var jsmacros=this.jsmacros;macro=jsmacros[ast.id];var jsArgs=[];if(macro&&macro.apply){utils.forEach(ast.args,function(a){jsArgs.push(this.getLiteral(a))},this);ret=macro.apply(this,jsArgs)}}else{var asts=macro.asts;var args=macro.args;var _call_args=ast.args;var local={};var localKey=[];var guid=utils.guid();var contextId=ast.id+":"+guid;utils.forEach(args,function(ref,i){if(_call_args[i]){local[ref.id]=this.getLiteral(_call_args[i])}else{local[ref.id]=undefined}},this);ret=this.eval(asts,local,contextId)}return ret},eval:function(str,local,contextId){if(!local){if(utils.isArray(str)){return this._render(str)}else{return this.evalStr(str)}}else{var asts=[];var Parser=Velocity.Parser;contextId=contextId||"eval:"+utils.guid();if(utils.isArray(str)){asts=str}else if(Parser){asts=Parser.parse(str)}if(asts.length){this.local[contextId]=local;var ret=this._render(asts,contextId);this.local[contextId]={};this.conditions.pop();this.condition="";return ret}}},getBlockEach:function(block){var ast=block[0];var _from=this.getLiteral(ast.from);var _block=block.slice(1);var _to=ast.to;var local={foreach:{count:0}};var ret="";var guid=utils.guid();var contextId="foreach:"+guid;var type={}.toString.call(_from);if(!_from||type!=="[object Array]"&&type!=="[object Object]")return;var len=utils.isArray(_from)?_from.length:utils.keys(_from).length;utils.forEach(_from,function(val,i){if(this.setBreak)return;local[_to]=val;local["foreach"]["count"]=i+1;local["foreach"]["index"]=i;local["foreach"]["hasNext"]=i+1<len;local["velocityCount"]=i+1;this.local[contextId]=local;ret+=this._render(_block,contextId)},this);this.setBreak=false;this.local[contextId]={};this.conditions.pop();this.condition="";return ret},getBlockIf:function(block){var str="";var received=false;var asts=[];utils.some(block,function(ast){if(ast.condition){if(received)return true;received=this.getExpression(ast.condition)}else if(ast.type==="else"){if(received)return true;received=true}else if(received){asts.push(ast)}return false},this);return this._render(asts)}})}(Velocity,utils);!function(Velocity,utils){var BLOCK_TYPES=["if","foreach","macro","noescape","define"];utils.mixin(Velocity.prototype,{init:function(){this.context={};this.macros={};this.conditions=[];this.local={};this.silence=false;utils.forEach(this.asts,this._init,this)},_init:function(ast,i){if(!ast.type||ast.type!=="references"){this._trim(i+1)}},_trim:function(i){var asts=this.asts;var _ast=asts[i];if(typeof _ast==="string"&&_ast.slice(0,1)==="\n"){asts[i]=_ast.slice(1)}},render:function(context,macros,silence){this.silence=!!silence;this.context=context||{};this.jsmacros=macros||{};var t1=utils.now();var str=this._render();var t2=utils.now();var cost=t2-t1;this.cost=cost;return str},_render:function(asts,contextId){var str="";var block=[];var index=0;asts=asts||this.asts;if(contextId){if(contextId!==this.condition)this.conditions.push(contextId);this.condition=contextId}else{this.condition=null}utils.forEach(asts,function(ast){var type=ast.type;if(utils.indexOf(type,BLOCK_TYPES)>-1)index++;if(type==="comment")return;if(index){type==="end"&&index--;if(index){block.push(ast);return}}switch(type){case"references":str+=this.getReferences(ast,true);break;case"set":this.setValue(ast);break;case"break":this.setBreak=true;break;case"macro_call":str+=this.getMacro(ast);break;case"end":str+=this.getBlock(block.slice());block=[];break;default:if(utils.isArray(ast)){str+=this.getBlock(ast)}else{str+=ast}break}},this);return str}})}(Velocity,utils);!function(Velocity,utils){utils.mixin(Velocity.prototype,{getExpression:function(ast){var exp=ast.expression;var ret;if(ast.type==="math"){switch(ast.operator){case"+":ret=this.getExpression(exp[0])+this.getExpression(exp[1]);break;case"-":ret=this.getExpression(exp[0])-this.getExpression(exp[1]);break;case"/":ret=this.getExpression(exp[0])/this.getExpression(exp[1]);break;case"%":ret=this.getExpression(exp[0])%this.getExpression(exp[1]);break;case"*":ret=this.getExpression(exp[0])*this.getExpression(exp[1]);break;case"||":ret=this.getExpression(exp[0])||this.getExpression(exp[1]);break;case"&&":ret=this.getExpression(exp[0])&&this.getExpression(exp[1]);break;case">":ret=this.getExpression(exp[0])>this.getExpression(exp[1]);break;case"<":ret=this.getExpression(exp[0])<this.getExpression(exp[1]);break;case"==":ret=this.getExpression(exp[0])==this.getExpression(exp[1]);break;case">=":ret=this.getExpression(exp[0])>=this.getExpression(exp[1]);break;case"<=":ret=this.getExpression(exp[0])<=this.getExpression(exp[1]);break;case"!=":ret=this.getExpression(exp[0])!=this.getExpression(exp[1]);break;case"minus":ret=-this.getExpression(exp[0]);break;case"not":ret=!this.getExpression(exp[0]);break;case"parenthesis":ret=this.getExpression(exp[0]);break;default:return}return ret}else{return this.getLiteral(ast)}}})}(Velocity,utils);!function(Velocity,utils){utils.mixin(Velocity.prototype,{getLiteral:function(literal){var type=literal.type;var ret="";if(type=="string"){ret=this.getString(literal)}else if(type=="integer"){ret=parseInt(literal.value,10)}else if(type=="array"){ret=this.getArray(literal)}else if(type=="map"){ret={};var map=literal.value;utils.forEach(map,function(exp,key){ret[key]=this.getLiteral(exp)},this)}else if(type=="bool"){if(literal.value==="null"){ret=null}else if(literal.value==="false"){ret=false}else if(literal.value==="true"){ret=true}}else{return this.getReferences(literal)}return ret},getString:function(literal){var val=literal.value;var ret=val;if(literal.isEval&&(val.indexOf("#")!==-1||val.indexOf("$")!==-1)){ret=this.evalStr(val)}return ret},getArray:function(literal){var ret=[];if(literal.isRange){var begin=literal.value[0];if(begin.type==="references"){begin=this.getReferences(begin)}var end=literal.value[1];if(end.type==="references"){end=this.getReferences(end)}end=parseInt(end,10);begin=parseInt(begin,10);var i;if(!isNaN(begin)&&!isNaN(end)){if(begin<end){for(i=begin;i<=end;i++)ret.push(i)}else{for(i=begin;i>=end;i--)ret.push(i)}}}else{utils.forEach(literal.value,function(exp){ret.push(this.getLiteral(exp))},this)}return ret},evalStr:function(str){if(Velocity.Parser){var asts=Velocity.Parser.parse(str);ret=this._render(asts)}else{var ret=str;var reg=/\$\{{0,1}([_a-z][a-z_\-0-9.]*)\}{0,1}/gi;var self=this;ret=ret.replace(reg,function(){return self._getFromVarname(arguments[1])})}return ret},_getFromVarname:function(varname){var varPath=varname.split(".");var ast={type:"references",id:varPath[0],leader:"$"};var path=[];for(var i=1;i<varPath.length;i++){path.push({type:"property",id:varPath[i]})}if(path.length)ast.path=path;return this.getReferences(ast)}})}(Velocity,utils);!function(Velocity,utils){function getSize(obj){if(utils.isArray(obj)){return obj.length}else if(typeof obj==="string"){return utils.keys(obj).length}return undefined}utils.mixin(Velocity.prototype,{getReferences:function(ast,isVal){var isSilent=this.silence||ast.leader==="$!";var isfn=ast.args!==undefined;var context=this.context;var ret=context[ast.id];var local=this.getLocal(ast);if(ret!==undefined&&isfn){ret=this.getPropMethod(ast,context)}if(local.isLocaled)ret=local["value"];var isSet=this.hasSetMethod(ast,ret);if(isSet!==false){if(!context[ast.id])context[ast.id]={};utils.mixin(context[ast.id],isSet);return""}if(ast.path&&ret!==undefined){utils.some(ast.path,function(property,i){ret=this.getAttributes(property,ret);return ret===undefined},this)}if(isVal&&ret===undefined)ret=isSilent?"":Velocity.Helper.getRefText(ast);return ret},hasSetMethod:function(ast,context){var len=ast.path&&ast.path.length;if(!len)return false;var lastId=""+ast.path[len-1].id;if(lastId.indexOf("set")!==0){return false}else{context=context||{};utils.forEach(ast.path,function(ast){if(ast.type==="method"&&ast.id.indexOf("set")===0){context[ast.id.slice(3)]=this.getLiteral(ast.args[0])}else{context[ast.id]=context[ast.id]||{}}},this);return context}},getLocal:function(ast){var id=ast.id;var local=this.local;var ret=false;var isLocaled=utils.some(this.conditions,function(contextId){var _local=local[contextId];if(id in _local){ret=_local[id];return true}return false},this);return{value:ret,isLocaled:isLocaled}},getAttributes:function(property,baseRef){var type=property.type;var ret;var id=property.id;if(type==="method"){ret=this.getPropMethod(property,baseRef)}else if(type==="property"){ret=baseRef[id]}else{ret=this.getPropIndex(property,baseRef)}return ret},getPropIndex:function(property,baseRef){var ast=property.id;var key;if(ast.type==="references"){key=this.getReferences(ast)}else if(ast.type==="integer"){key=ast.value}else{key=ast.value}return baseRef[key]},getPropMethod:function(property,baseRef){var id=property.id;var ret="";var _id=id.slice(3);if(id.indexOf("get")===0&&!(id in baseRef)){if(_id){ret=baseRef[_id]}else{_id=this.getLiteral(property.args[0]);ret=baseRef[_id]}return ret}else if(id.indexOf("is")===0&&!(id in baseRef)){_id=id.slice(2);ret=baseRef[_id];return ret}else if(id==="keySet"){return utils.keys(baseRef)}else if(id==="entrySet"){ret=[];utils.forEach(baseRef,function(value,key){ret.push({key:key,value:value})});return ret}else if(id==="size"){return getSize(baseRef)}else{ret=baseRef[id];var args=[];utils.forEach(property.args,function(exp){args.push(this.getLiteral(exp))},this);if(ret&&ret.call){ret=ret.apply(baseRef,args)}else{ret=undefined}}return ret}})}(Velocity,utils);!function(Velocity,utils){utils.mixin(Velocity.prototype,{getContext:function(){var condition=this.condition;var local=this.local;if(condition){return local[condition]}else{return this.context}},setValue:function(ast){var ref=ast.equal[0];var context=this.getContext();var valAst=ast.equal[1];var val;if(valAst.type==="math"){val=this.getExpression(valAst)}else{val=this.getLiteral(ast.equal[1])}if(!ref.path){context[ref.id]=val}else{var baseRef=context[ref.id];if(typeof baseRef!="object"){baseRef={}}context[ref.id]=baseRef;var len=ref.path?ref.path.length:0;utils.forEach(ref.path,function(exp,i){var isEnd=len===i+1;var key=exp.id;if(exp.type==="index")key=key.value;baseRef[key]=isEnd?val:{};baseRef=baseRef[key]})}}})}(Velocity,utils);win.Velocity=Velocity})(this);